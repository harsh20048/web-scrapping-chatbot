<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto-Learning Website Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <style>
      /* Simplified modal CSS directly in the HTML */
      #history-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      
      #history-popup.active {
        display: flex;
      }
      
      #history-popup-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }
      
      #history-popup-close {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        background-color: #e9ecef;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #history-popup-close:hover {
        background-color: #ced4da;
      }
      
      #history-popup-list {
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .history-item {
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
      }
      
      .history-item.user {
        background-color: rgba(67, 97, 238, 0.05);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1><i class="fas fa-robot"></i> Auto-Learning Website Chatbot</h1>
        <p>Powered by Multiple LLM Models with Smart Fallback System</p>
      </header>

      <div class="main-content">
        <aside class="setup-panel">
          <h2><i class="fas fa-cogs"></i> Setup</h2>
          <div class="form-group">
            <label for="website-url">Website URL to scrape:</label>
            <div class="input-with-icon">
              <i class="fas fa-globe"></i>
              <input
                type="url"
                id="website-url"
                placeholder="https://example.com"
                required
              />
            </div>
          </div>
          <button id="start-scrape" class="primary-button">
            <i class="fas fa-spider"></i> Start Scraping
          </button>
          
          <div id="scraping-status" class="status-box hidden">
            <p id="status-text">Scraping in progress...</p>
            <div class="loader"></div>
          </div>
          
          <div class="button-group">
            <button id="reset-db" class="secondary-button">
              <i class="fas fa-trash-alt"></i> Reset Database
            </button>
            <button id="show-history-btn" class="secondary-button">
              <i class="fas fa-history"></i> History
            </button>
          </div>
          
          <div id="system-status" class="status-info">
            <p><i class="fas fa-database"></i> Documents: <span id="doc-count">0</span></p>
            <p><i class="fas fa-microchip"></i> Model: <span id="model-name">-</span></p>
            <p><i class="fas fa-server"></i> Ollama: <span id="ollama-status">-</span></p>
          </div>
        </aside>

        <main class="chat-container">
          <div id="chat-messages">
            <div class="message system">
              <div class="message-content">
                <p>
                  <i class="fas fa-info-circle"></i> Welcome to the Auto-Learning Website Chatbot! Start by
                  entering a website URL to scrape, then you can ask questions
                  about the website content.
                </p>
              </div>
            </div>
          </div>
          
          <div class="chat-input-container">
            <div class="chat-mode-toggle">
              <label><i class="fas fa-exchange-alt"></i> Chat Mode:</label>
              <div class="mode-buttons">
                <button
                  id="mode-flash"
                  class="mode-button selected"
                  title="llama3.2:1b-instruct-q2_K - Optimized for speed with good accuracy"
                >
                  <i class="fas fa-bolt"></i> Flash
                </button>
                <button id="mode-deep-analysis" class="mode-button">
                  <i class="fas fa-search-plus"></i> Deep Analysis
                </button>
                <button
                  id="mode-deep"
                  class="mode-button"
                  title="phi3.5:3.8b-mini-instruct-q3_K_S"
                >
                  <i class="fas fa-layer-group"></i> Deep
                </button>
                <button
                  id="mode-deepseek"
                  class="mode-button"
                  title="codegemma:2b-code"
                >
                  <i class="fas fa-code"></i> DeepSeek
                </button>
              </div>
            </div>
            
            <div class="input-group">
              <div class="input-with-icon">
                <i class="fas fa-comment-alt"></i>
                <input
                  type="text"
                  id="chat-input"
                  placeholder="Ask a question..."
                  disabled
                />
              </div>
              <div class="input-actions">
                <button id="send-message" class="primary-button" disabled>
                  <i class="fas fa-paper-plane"></i> Send
                </button>
                <button
                  id="stop-process"
                  class="danger-button"
                  style="display: none;"
                >
                  <i class="fas fa-stop-circle"></i> Stop
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>

      <section class="embed-code-container">
        <h2><i class="fas fa-code"></i> Embed on Your Website</h2>
        <p>Copy this code to embed the chatbot on your website:</p>
        <div class="code-block">
          <pre><code>&lt;script src="<span id="embed-url">http://localhost:5000/embed/chatbot.js</span>"&gt;&lt;/script&gt;</code></pre>
          <button id="copy-embed" class="secondary-button">
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
      </section>

      <footer>
        <p>
          <i class="fas fa-robot"></i> Auto-Learning Website Chatbot - Powered by Multiple LLM Models with
          Fallback
        </p>
        <p class="copyright"> 2025 - All Rights Reserved</p>
      </footer>
    </div>

    <!-- Simple History Popup -->
    <div id="history-popup">
      <div id="history-popup-content">
        <button id="history-popup-close"><i class="fas fa-times"></i></button>
        <h3><i class="fas fa-history"></i> Chat History</h3>
        <button id="download-history" class="secondary-button">
          <i class="fas fa-download"></i> Download Chat History
        </button>
        <div id="history-popup-list"></div>
      </div>
    </div>

    <!-- Main application script -->
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    
    <!-- Simple history popup script -->
    <script>
      // Direct implementation of history popup functionality
      document.addEventListener('DOMContentLoaded', function() {
        const showHistoryBtn = document.getElementById('show-history-btn');
        const historyPopup = document.getElementById('history-popup');
        const historyPopupClose = document.getElementById('history-popup-close');
        const historyPopupList = document.getElementById('history-popup-list');
        const downloadHistoryBtn = document.getElementById('download-history');
        
        // Show history popup
        showHistoryBtn.addEventListener('click', function() {
          fetch('/api/chat_history')
            .then(response => response.json())
            .then(data => {
              historyPopupList.innerHTML = '';
              
              if (data.history && data.history.length > 0) {
                data.history.forEach(item => {
                  const div = document.createElement('div');
                  div.className = 'history-item ' + item.role;
                  
                  const roleIcon = item.role === 'user' 
                    ? '<i class="fas fa-user"></i>' 
                    : '<i class="fas fa-robot"></i>';
                  
                  const roleLabel = item.role === 'user' ? 'You' : 'Bot';
                  const message = typeof item.message === 'string' 
                    ? item.message 
                    : JSON.stringify(item.message);
                  
                  div.innerHTML = `<strong>${roleIcon} ${roleLabel}:</strong> ${message}`;
                  historyPopupList.appendChild(div);
                });
              } else {
                historyPopupList.innerHTML = '<div class="history-item"><i class="fas fa-info-circle"></i> No chat history.</div>';
              }
              
              historyPopup.classList.add('active');
            })
            .catch(error => {
              console.error('Error loading chat history:', error);
              alert('Failed to load chat history. Please try again.');
            });
        });
        
        // Close history popup
        historyPopupClose.addEventListener('click', function() {
          historyPopup.classList.remove('active');
        });
        
        // Close when clicking outside the content
        historyPopup.addEventListener('click', function(event) {
          if (event.target === historyPopup) {
            historyPopup.classList.remove('active');
          }
        });
        
        // Download chat history
        downloadHistoryBtn.addEventListener('click', function() {
          fetch('/api/chat_history')
            .then(response => response.json())
            .then(data => {
              const blob = new Blob([JSON.stringify(data.history, null, 2)], {type: 'application/json'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'chat_history.json';
              document.body.appendChild(a);
              a.click();
              setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }, 100);
            })
            .catch(error => {
              console.error('Error downloading chat history:', error);
              alert('Failed to download chat history. Please try again.');
            });
        });
        
        // Close on escape key
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape' && historyPopup.classList.contains('active')) {
            historyPopup.classList.remove('active');
          }
        });
      });
    </script>
  </body>
</html>
